name: Build and Deploy to Azure

on:
  push:
    branches:
      - main
      - production
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: ubuntuairlabacr
  IMAGE_NAME: ubuntuairlab-backend
  RESOURCE_GROUP: ubuntuairlab-rg
  APP_NAME: ubuntuairlab-api

jobs:
  # =============================================================================
  # Job 1: Build and Test
  # =============================================================================
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      
      - name: Run linting
        run: |
          pip install flake8
          flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      - name: Run tests
        run: |
          # pytest tests/ --cov=app --cov-report=xml
          echo "Tests will be added in future"
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # =============================================================================
  # Job 2: Build Docker Image and Push to ACR
  # =============================================================================
  build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set image tag
        id: set-tag
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/production" ]]; then
            echo "tag=production-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          echo "sha-tag=${{ github.sha }}" >> $GITHUB_OUTPUT
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}
      
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.tag }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.sha-tag }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .
      
      - name: Push Docker image to ACR
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.sha-tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
      
      - name: Azure Logout
        run: az logout
        if: always()

  # =============================================================================
  # Job 3: Deploy to Azure App Service
  # =============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    environment:
      name: ${{ github.ref == 'refs/heads/production' && 'production' || 'staging' }}
      url: https://${{ env.APP_NAME }}.azurewebsites.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}
      
      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting 60 seconds for container to start..."
          sleep 60
      
      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -f https://${{ env.APP_NAME }}.azurewebsites.net/ -m 10; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Health check failed after 10 attempts"
          exit 1
      
      - name: Run database migrations
        run: |
          echo "Database migrations should be run manually or via SSH"
          echo "Command: az webapp ssh --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.APP_NAME }}"
          echo "Then: alembic upgrade head"
        continue-on-error: true
      
      - name: Azure Logout
        run: az logout
        if: always()

  # =============================================================================
  # Job 4: Notify Deployment Status
  # =============================================================================
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-test, build-and-push, deploy]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment successful!"
            echo "üåê URL: https://${{ env.APP_NAME }}.azurewebsites.net"
            echo "üìä Docs: https://${{ env.APP_NAME }}.azurewebsites.net/docs"
          else
            echo "‚ùå Deployment failed or was skipped"
          fi
      
      # Add Slack/Discord/Teams notification here if needed
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     channel-id: 'deployments'
      #     slack-message: "Deployment ${{ needs.deploy.result }}: ${{ github.event.head_commit.message }}"
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
